function whichTransitionEvent(){var t,i=document.createElement("fakeelement"),e={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in e)if(void 0!==i.style[t])return e[t]}!function(t,i){var e=function(t,i,e){var a;return function(){function n(){e||t.apply(o,s),a=null}var o=this,s=arguments;a?clearTimeout(a):e&&t.apply(o,s),a=setTimeout(n,i||100)}};jQuery.fn[i]=function(t){return t?this.bind("resize",e(t)):this.trigger(i)}}(jQuery,"smartresize");var customTransitionEnd=whichTransitionEvent();!function(t){var i=0;t.fn.fluidbox=function(e){var a=t.extend(!0,{immediate:!1,viewportFill:.95,debounceResize:!0,stackIndex:1e3,stackIndexDelta:10,closeTrigger:[{selector:".fluidbox-overlay",event:"click"},{selector:"document",event:"keyup",keyCode:27}]},e),n=["keyup","keydown","keypress"];a.stackIndex<a.stackIndexDelta&&(a.stackIndexDelta=a.stackIndex),$fbOverlay=t("<div />",{"class":"fluidbox-overlay",css:{"z-index":a.stackIndex}});var o,s=this,d=t(window),r=function(i){t(i+".fluidbox-opened").trigger("click")},l=function(t,i){var e=t.find("img"),n=t.find(".fluidbox-ghost"),s=t.find(".fluidbox-wrap"),r=t.data(),l=0,c=0;e.data().imgRatio=r.natWidth/r.natHeight;var f,h,u;if(o>e.data().imgRatio)l=!a.immediate&&r.natHeight<d.height()*a.viewportFill?r.natHeight:d.height()*a.viewportFill,r.imgScale=l/e.height(),r.imgScaleY=r.imgScale,f=e.height()*r.imgScaleY,h=f/r.natHeight,u=r.natWidth*h/e.width(),r.imgScaleX=u;else{c=!a.immediate&&r.natWidth<d.width()*a.viewportFill?r.natWidth:d.width()*a.viewportFill,r.imgScale=c/e.width(),r.imgScaleX=r.imgScale;var g=e.width()*r.imgScaleX,h=g/r.natWidth,u=r.natHeight*h/e.height();r.imgScaleY=u}var p=d.scrollTop()-e.offset().top+.5*e.data("imgHeight")*(e.data("imgScale")-1)+.5*(d.height()-e.data("imgHeight")*e.data("imgScale")),m=.5*e.data("imgWidth")*(e.data("imgScale")-1)+.5*(d.width()-e.data("imgWidth")*e.data("imgScale"))-e.offset().left,x=parseInt(1e3*r.imgScaleX)/1e3+","+parseInt(1e3*r.imgScaleY)/1e3;n.css({transform:"translate("+parseInt(10*m)/10+"px,"+parseInt(10*p)/10+"px) scale("+x+")",top:e.offset().top-s.offset().top,left:e.offset().left-s.offset().left}).one(customTransitionEnd,function(){t.trigger(i)})},c=function(t){function i(){r.imgWidth=e.width(),r.imgHeight=e.height(),r.imgRatio=e.width()/e.height(),n.css({width:e.width(),height:e.height(),top:e.offset().top-s.offset().top+parseInt(e.css("borderTopWidth"))+parseInt(e.css("paddingTop")),left:e.offset().left-s.offset().left+parseInt(e.css("borderLeftWidth"))+parseInt(e.css("paddingLeft"))}),r.imgScale=o>r.imgRatio?d.height()*a.viewportFill/e.height():d.width()*a.viewportFill/e.width()}if(o=d.width()/d.height(),t.hasClass("fluidbox")){var e=t.find("img"),n=t.find(".fluidbox-ghost"),s=t.find(".fluidbox-wrap"),r=e.data();i(),e.load(i)}},f=function(i){if(t(this).hasClass("fluidbox")){var e=t(this),n=t(this).find("img"),o=t(this).find(".fluidbox-ghost"),s=t(this).find(".fluidbox-wrap"),d={},r=function(){var i=e.attr("data-fluidbox-width")||t(this)[0].naturalWidth,r=e.attr("data-fluidbox-height")||t(this)[0].naturalHeight;e.data("natWidth",i).data("natHeight",r),e.append($fbOverlay).data("fluidbox-state",1).removeClass("fluidbox-closed").addClass("fluidbox-opened"),d.close&&window.clearTimeout(d.close),d.open=window.setTimeout(function(){t(".fluidbox-overlay").css({opacity:1})},10),t(".fluidbox-wrap").css({zIndex:a.stackIndex-a.stackIndexDelta-1}),s.css({"z-index":a.stackIndex+a.stackIndexDelta}),o.css({"background-image":"url("+n.attr("src")+")",opacity:1}),n.css({opacity:0}),t("<img />",{src:e.attr("href")}).load(function(){o.css({"background-image":"url("+e.attr("href")+")"}),e.removeClass("fluidbox-loading"),o.removeClass("fluidbox-loading"),t(this).remove()}),l(e,"openend")};0!==t(this).data("fluidbox-state")&&t(this).data("fluidbox-state")?(e.trigger("closestart"),e.data("fluidbox-state",0).removeClass("fluidbox-opened").addClass("fluidbox-closed"),d.open&&window.clearTimeout(d.open),d.close=window.setTimeout(function(){t(".fluidbox-overlay").remove(),s.css({"z-index":a.stackIndex-a.stackIndexDelta})},10),t(".fluidbox-overlay").css({opacity:0}),o.css({transform:"translate(0,0) scale(1)",opacity:0,top:n.offset().top-s.offset().top+parseInt(n.css("borderTopWidth"))+parseInt(n.css("paddingTop")),left:n.offset().left-s.offset().left+parseInt(n.css("borderLeftWidth"))+parseInt(n.css("paddingLeft"))}).one(customTransitionEnd,function(){e.trigger("closeend")}),n.css({opacity:1})):(t(this).trigger("openstart"),t("<img />",{src:n.attr("src")}).load(function(){e.addClass("fluidbox-loading"),o.addClass("fluidbox-loading"),a.immediate?r.call(this):t("<img />",{src:e.attr("href")}).load(r)})),i.preventDefault()}},h=function(i){i?c(i):s.each(function(){c(t(this))});var e=t("a.fluidbox.fluidbox-opened");e.length>0&&l(e,"resizeend")};return a.debounceResize?t(window).smartresize(function(){h()}):t(window).resize(function(){h()}),s.each(function(){if(t(this).is("a")&&1===t(this).children().length&&t(this).children().is("img")&&"none"!==t(this).css("display")&&"none"!==t(this).parents().css("display")){var e=t("<div />",{"class":"fluidbox-wrap",css:{"z-index":a.stackIndex-a.stackIndexDelta}});i+=1;var o=t(this);o.addClass("fluidbox fluidbox-closed").attr("id","fluidbox-"+i).wrapInner(e).find("img").css({opacity:1}).after('<div class="fluidbox-ghost"><div class="fluidbox-status"></div></div>').each(function(){var i=t(this);i.width()>0&&i.height()>0?(c(o),o.click(f)):i.load(function(){c(o),o.click(f)})}),t(this).on("recompute",function(){h(t(this)),t(this).trigger("recomputeend")});var s="#fluidbox-"+i;a.closeTrigger&&t.each(a.closeTrigger,function(i){var e=a.closeTrigger[i];"window"!=e.selector?"document"==e.selector&&(e.keyCode&&n.indexOf(e.event)>-1?t(document).on(e.event,function(t){t.keyCode==e.keyCode&&r(s)}):t(document).on(e.event,s,function(){r(s)})):d.on(e.event,function(){r(s)})})}}),s}}(jQuery);
